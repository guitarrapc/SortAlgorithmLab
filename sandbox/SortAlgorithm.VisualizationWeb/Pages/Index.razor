@page "/"
@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@using SortAlgorithm.VisualizationWeb.Components
@inject PlaybackService Playback
@inject SortExecutor Executor
@inject AlgorithmRegistry Registry
@implements IDisposable

<PageTitle>Sort Algorithm Visualization</PageTitle>

<div class="visualization-page" 
     style="--sidebar-width: @(_sidebarCollapsed ? "40" : _sidebarWidth)px; user-select: @(_isResizing ? "none" : "auto");"
     @onmousemove="OnMouseMove" 
     @onmouseup="OnMouseUp"
     @onmousemove:preventDefault="@_isResizing">
    <div class="header">
        <h1>üé® Sort Algorithm Visualization</h1>
        <div>
            <select @bind="SelectedCategory">
                <option value="">All Categories</option>
                @foreach (var category in Registry.GetCategories())
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
    </div>
    
    <div class="sidebar @(_sidebarCollapsed ? "collapsed" : "")">
        <div class="sidebar-resizer" 
             @onmousedown="StartResize" 
             @onmousedown:preventDefault></div>
        
        <button class="sidebar-toggle" 
                @onclick="ToggleSidebar"
                title="@(_sidebarCollapsed ? "Show Sidebar" : "Hide Sidebar")">
            @(_sidebarCollapsed ? "‚ñ∂" : "‚óÄ")
        </button>
        
        <div class="sidebar-content">
            <div class="statistics-panel">
                <h3>‚öôÔ∏è Settings</h3>
            
            <div class="stat-item">
                <span class="stat-label">Algorithm</span>
                <select @bind="SelectedAlgorithm" @bind:after="OnAlgorithmChanged" style="width: 100%;">
                    @foreach (var algo in GetFilteredAlgorithms())
                    {
                        <option value="@algo.Name">@algo.Name</option>
                    }
                </select>
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Array Size @GetSizeRecommendation()</span>
                <select @bind="ArraySize">
                    @foreach (var size in AvailableSizes)
                    {
                        <option value="@size">@size @(IsRecommendedSize(size) ? "‚≠ê" : "")</option>
                    }
                </select>
            </div>
            
            <div class="stat-item">
                <button class="primary" @onclick="GenerateAndSort" style="width: 100%;">üé≤ Generate & Sort</button>
            </div>
            
            <div class="stat-item">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="Playback.AutoReset" />
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Auto Reset on Complete</span>
                </label>
            </div>
            
            <div class="stat-item stat-item-vertical">
                <span class="stat-label">Operations Per Frame</span>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="stat-value" style="font-size: 0.9rem;">@Playback.OperationsPerFrame ops/frame</span>
                </div>
                <input type="range" min="1" max="1000" @bind="Playback.OperationsPerFrame" @bind:after="StateHasChanged" style="width: 100%;" />
            </div>
            
            <div class="stat-item stat-item-vertical">
                <span class="stat-label">Speed Multiplier</span>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="stat-value" style="font-size: 0.9rem;">@Playback.SpeedMultiplier.ToString("F1")x</span>
                    <span style="font-size: 0.85rem; color: #999;">(@EffectiveFPS FPS)</span>
                </div>
                <input type="range" min="0.1" max="100" step="0.5" @bind="Playback.SpeedMultiplier" @bind:after="OnSpeedMultiplierChanged" style="width: 100%;" />
            </div>
        </div>
        
        <StatisticsPanel State="Playback.State" />
        
        <div class="stat-item" style="margin-top: 20px;">
            <span class="stat-label">Complexity</span>
            <span class="stat-value" style="font-size: 0.9rem;">@GetSelectedAlgorithmComplexity()</span>
        </div>
        </div>
    </div>
    
    <div class="visualization-area">
        <div class="visualization-content">
            @if (Playback.State.MainArray.Length > 0)
            {
                <BarChartRenderer State="Playback.State" 
                                 OnClick="OnVisualizationClick" />
            }
            else
            {
                <div style="text-align: center; color: #999;">
                    <p style="font-size: 2rem;">üìä</p>
                    <p>Click "Generate & Sort" to start visualization</p>
                </div>
            }
        </div>
    </div>
    
    <div class="controls">
        <SeekBar CurrentIndex="Playback.State.CurrentOperationIndex"
                TotalOperations="Playback.State.TotalOperations"
                OnSeek="OnSeek" />
        
        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
            <button @onclick="Playback.Stop">‚èπ Reset</button>
            <button @onclick="Playback.TogglePlayPause">
                @(Playback.State.PlaybackState == PlaybackState.Playing ? "‚è∏ Pause" : "‚ñ∂ Play")
            </button>
            <span style="flex: 1;"></span>
            <span style="color: #999;">Mode: @Playback.State.Mode</span>
        </div>
    </div>
</div>

@code {
private string SelectedAlgorithm { get; set; } = "BubbleSort";
private string SelectedCategory { get; set; } = "";
private int ArraySize { get; set; } = 64;
    
    private int[] AvailableSizes = [16, 32, 64, 128, 256, 512, 1024, 2048, 4096];
    
    private int EffectiveFPS => (int)(60 * Playback.SpeedMultiplier);
    
    // „Çµ„Ç§„Éâ„Éê„Éº„É™„Çµ„Ç§„Ç∫Èñ¢ÈÄ£
    private int _sidebarWidth = 280; // „Éá„Éï„Ç©„É´„ÉàÂπÖÔºàpxÔºâ
    private bool _sidebarCollapsed = false; // Êäò„Çä„Åü„Åü„ÅøÁä∂ÊÖã
    private bool _isResizing = false;
    private int _resizeStartX = 0;
    private int _resizeStartWidth = 0;
    
    protected override void OnInitialized()
    {
        Playback.StateChanged += OnStateChanged;
        // ÂàùÊúü„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅÆÊé®Â•®„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
        SetRecommendedSize();
    }
    
    private void ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
        StateHasChanged();
    }
    
    private void OnSpeedMultiplierChanged()
    {
        // ÂÜçÁîü‰∏≠„ÅÆÂ†¥Âêà„ÄÅ„Çø„Ç§„Éû„ÉºÈñìÈöî„ÇíÊõ¥Êñ∞
        if (Playback.State.PlaybackState == PlaybackState.Playing)
        {
            Playback.Pause();
            Playback.Play();
        }
        StateHasChanged();
    }
    
protected override async Task OnAfterRenderAsync(bool firstRender)
{
    if (firstRender)
    {
        // „Ç∞„É≠„Éº„Éê„É´„Å™„Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÁôªÈå≤ÔºàJS Interop‰∏çË¶Å„ÄÅBlazorÂÅ¥„ÅßÂá¶ÁêÜÔºâ
    }
}
    
private void StartResize(MouseEventArgs e)
{
    _isResizing = true;
    _resizeStartX = (int)e.ClientX;
    _resizeStartWidth = _sidebarWidth;
}
    
private void OnMouseMove(MouseEventArgs e)
{
    if (_isResizing)
    {
        var deltaX = (int)e.ClientX - _resizeStartX;
        var newWidth = _resizeStartWidth + deltaX;
            
        // ÊúÄÂ∞è200px„ÄÅÊúÄÂ§ß500px„Å´Âà∂Èôê
        _sidebarWidth = Math.Clamp(newWidth, 200, 500);
        StateHasChanged();
    }
}
    
private void OnMouseUp()
{
    _isResizing = false;
}
    
private void OnAlgorithmChanged()
{
    SetRecommendedSize();
    StateHasChanged();
}
    
private void SetRecommendedSize()
{
    var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
    if (algo != null)
    {
        ArraySize = algo.RecommendedSize;
    }
}
    
private string GetSizeRecommendation()
{
    var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
    if (algo != null && algo.RecommendedSize != ArraySize)
    {
        return $"(Recommended: {algo.RecommendedSize})";
    }
    return "";
}
    
private bool IsRecommendedSize(int size)
{
    var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
    return algo?.RecommendedSize == size;
}
    
    private IEnumerable<AlgorithmMetadata> GetFilteredAlgorithms()
    {
        var algorithms = string.IsNullOrEmpty(SelectedCategory)
            ? Registry.GetAllAlgorithms()
            : Registry.GetByCategory(SelectedCategory);
        
        return algorithms.OrderBy(a => a.Name);
    }
    
    private string GetSelectedAlgorithmComplexity()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        return algo?.TimeComplexity ?? "Unknown";
    }
    
    private void GenerateAndSort()
    {
        var metadata = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (metadata == null)
        {
            Console.WriteLine($"Algorithm not found: {SelectedAlgorithm}");
            return;
        }
        
        // Ë¶ÅÁ¥†Êï∞Âà∂Èôê„ÇíÈÅ©Áî®Ôºà„Åô„Åπ„Å¶„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Åß4096„Åæ„ÅßÂØæÂøúÔºâ
        var size = Math.Min(ArraySize, metadata.MaxElements);
        
        // „É©„É≥„ÉÄ„É†ÈÖçÂàóÁîüÊàêÔºà‰∏ÄÂ∫¶„Å†„ÅëÁîüÊàêÔºâ
        var random = new Random();
        var array = Enumerable.Range(1, size).OrderBy(_ => random.Next()).ToArray();
        
        // „ÇΩ„Éº„ÉàÂÆüË°å„Å®Êìç‰ΩúË®òÈå≤ÔºàReadOnlySpan„Çí‰ΩøÁî®Ôºâ
        try
        {
            var operations = Executor.ExecuteAndRecord(array.AsSpan(), metadata);
            Playback.LoadOperations(array.AsSpan(), operations);
            Console.WriteLine($"Loaded {operations.Count} operations for {SelectedAlgorithm}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error executing sort: {ex.Message}");
        }
    }
    
    private void OnVisualizationClick()
    {
        Playback.TogglePlayPause();
    }
    
    private void OnSeek(int index)
    {
        Playback.SeekTo(index);
    }
    
    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        Playback.StateChanged -= OnStateChanged;
    }
}

