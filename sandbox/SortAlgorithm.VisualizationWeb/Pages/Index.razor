@page "/"
@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@using SortAlgorithm.VisualizationWeb.Components
@inject PlaybackService Playback
@inject SortExecutor Executor
@inject AlgorithmRegistry Registry
@implements IDisposable

<PageTitle>Sort Algorithm Visualization</PageTitle>

<div class="visualization-page">
    <div class="header">
        <h1>üé® Sort Algorithm Visualization</h1>
        <div>
            <select @bind="SelectedCategory">
                <option value="">All Categories</option>
                @foreach (var category in Registry.GetCategories())
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
    </div>
    
    <div class="sidebar">
        <div class="statistics-panel">
            <h3>‚öôÔ∏è Settings</h3>
            
            <div class="stat-item">
                <span class="stat-label">Algorithm</span>
                <select @bind="SelectedAlgorithm" @bind:after="OnAlgorithmChanged" style="width: 100%;">
                    @foreach (var algo in GetFilteredAlgorithms())
                    {
                        <option value="@algo.Name">@algo.Name</option>
                    }
                </select>
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Array Size @GetSizeRecommendation()</span>
                <select @bind="ArraySize">
                    @foreach (var size in AvailableSizes)
                    {
                        <option value="@size">@size @(IsRecommendedSize(size) ? "‚≠ê" : "")</option>
                    }
                </select>
            </div>
            
            <div class="stat-item">
                <button class="primary" @onclick="GenerateAndSort" style="width: 100%;">üé≤ Generate & Sort</button>
            </div>
            
            <div class="stat-item">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="Playback.AutoReset" />
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Auto Reset on Complete</span>
                </label>
            </div>
            
            <div class="stat-item">
                <span class="stat-label">Speed: @Playback.OperationsPerFrame ops/frame (@EffectiveOpsPerSecond ops/sec)</span>
                <input type="range" min="1" max="1000" @bind="Playback.OperationsPerFrame" @bind:after="StateHasChanged" style="width: 100%;" />
                <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #999; margin-top: 4px;">
                    <span>1 (slow)</span>
                    <span>10</span>
                    <span>100</span>
                    <span>1000 (fast)</span>
                </div>
            </div>
        </div>
        
        <StatisticsPanel State="Playback.State" />
        
        <div class="stat-item" style="margin-top: 20px;">
            <span class="stat-label">Complexity</span>
            <span class="stat-value" style="font-size: 0.9rem;">@GetSelectedAlgorithmComplexity()</span>
        </div>
    </div>
    
    <div class="visualization-area">
        <div style="flex: 1; display: flex; align-items: center; justify-content: center; background-color: #1A1A1A; border-radius: 8px;">
            @if (Playback.State.MainArray.Length > 0)
            {
                <BarChartRenderer State="Playback.State" 
                                 Width="1200" 
                                 Height="600" 
                                 OnClick="OnVisualizationClick" />
            }
            else
            {
                <div style="text-align: center; color: #999;">
                    <p style="font-size: 2rem;">üìä</p>
                    <p>Click "Generate & Sort" to start visualization</p>
                </div>
            }
        </div>
    </div>
    
    <div class="controls">
        <SeekBar CurrentIndex="Playback.State.CurrentOperationIndex"
                TotalOperations="Playback.State.TotalOperations"
                OnSeek="OnSeek" />
        
        <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
            <button @onclick="Playback.Stop">‚èπ Reset</button>
            <button @onclick="Playback.TogglePlayPause">
                @(Playback.State.PlaybackState == PlaybackState.Playing ? "‚è∏ Pause" : "‚ñ∂ Play")
            </button>
            <span style="flex: 1;"></span>
            <span style="color: #999;">Mode: @Playback.State.Mode</span>
        </div>
    </div>
</div>

@code {
private string SelectedAlgorithm { get; set; } = "BubbleSort";
private string SelectedCategory { get; set; } = "";
private int ArraySize { get; set; } = 64;
    
private int[] AvailableSizes = [16, 32, 64, 128, 256, 512, 1024, 2048, 4096];
    
private int EffectiveOpsPerSecond => Playback.OperationsPerFrame * 60; // 60 FPSÂõ∫ÂÆö
    
protected override void OnInitialized()
{
    Playback.StateChanged += OnStateChanged;
    // ÂàùÊúü„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅÆÊé®Â•®„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
    SetRecommendedSize();
}
    
private void OnAlgorithmChanged()
{
    SetRecommendedSize();
    StateHasChanged();
}
    
private void SetRecommendedSize()
{
    var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
    if (algo != null)
    {
        ArraySize = algo.RecommendedSize;
    }
}
    
private string GetSizeRecommendation()
{
    var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
    if (algo != null && algo.RecommendedSize != ArraySize)
    {
        return $"(Recommended: {algo.RecommendedSize})";
    }
    return "";
}
    
private bool IsRecommendedSize(int size)
{
    var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
    return algo?.RecommendedSize == size;
}
    
    private IEnumerable<AlgorithmMetadata> GetFilteredAlgorithms()
    {
        var algorithms = string.IsNullOrEmpty(SelectedCategory)
            ? Registry.GetAllAlgorithms()
            : Registry.GetByCategory(SelectedCategory);
        
        return algorithms.OrderBy(a => a.Name);
    }
    
    private string GetSelectedAlgorithmComplexity()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        return algo?.TimeComplexity ?? "Unknown";
    }
    
    private void GenerateAndSort()
    {
        var metadata = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (metadata == null)
        {
            Console.WriteLine($"Algorithm not found: {SelectedAlgorithm}");
            return;
        }
        
        // Ë¶ÅÁ¥†Êï∞Âà∂Èôê„ÇíÈÅ©Áî®Ôºà„Åô„Åπ„Å¶„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Åß4096„Åæ„ÅßÂØæÂøúÔºâ
        var size = Math.Min(ArraySize, metadata.MaxElements);
        
        // „É©„É≥„ÉÄ„É†ÈÖçÂàóÁîüÊàêÔºà‰∏ÄÂ∫¶„Å†„ÅëÁîüÊàêÔºâ
        var random = new Random();
        var array = Enumerable.Range(1, size).OrderBy(_ => random.Next()).ToArray();
        
        // „ÇΩ„Éº„ÉàÂÆüË°å„Å®Êìç‰ΩúË®òÈå≤ÔºàReadOnlySpan„Çí‰ΩøÁî®Ôºâ
        try
        {
            var operations = Executor.ExecuteAndRecord(array.AsSpan(), metadata);
            Playback.LoadOperations(array.AsSpan(), operations);
            Console.WriteLine($"Loaded {operations.Count} operations for {SelectedAlgorithm}");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error executing sort: {ex.Message}");
        }
    }
    
    private void OnVisualizationClick()
    {
        Playback.TogglePlayPause();
    }
    
    private void OnSeek(int index)
    {
        Playback.SeekTo(index);
    }
    
    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }
    
    public void Dispose()
    {
        Playback.StateChanged -= OnStateChanged;
    }
}

