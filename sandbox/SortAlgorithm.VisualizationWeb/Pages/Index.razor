@page "/"
@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@using SortAlgorithm.VisualizationWeb.Components
@inject PlaybackService Playback
@inject SortExecutor Executor
@inject AlgorithmRegistry Registry
@inject ArrayPatternGenerator PatternGenerator
@inject ComparisonModeService ComparisonMode
@implements IDisposable

<PageTitle>Sort Algorithm Visualization</PageTitle>

<div class="visualization-page"
     style="--sidebar-width: @(_sidebarCollapsed ? "40" : _sidebarWidth)px; user-select: @(_isResizing ? "none" : "auto");"
     @onmousemove="OnMouseMove"
     @onmouseup="OnMouseUp"
     @onmousemove:preventDefault="@_isResizing">
    <div class="header">
        <h1>
            ğŸ¨ Sort Algorithm Visualization
            @if (!string.IsNullOrEmpty(_runningAlgorithmName))
            {
                <span style="font-size: 0.6em; color: #888; margin-left: 1em;">- @_runningAlgorithmName</span>
            }
        </h1>
        <div>
            <select @bind="SelectedCategory">
                <option value="">All Categories</option>
                @foreach (var category in Registry.GetCategories())
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
    </div>

    <div class="sidebar @(_sidebarCollapsed ? "collapsed" : "")">
        <div class="sidebar-resizer"
             @onmousedown="StartResize"
             @onmousedown:preventDefault></div>

        <button class="sidebar-toggle"
                @onclick="ToggleSidebar"
                title="@(_sidebarCollapsed ? "Show Sidebar" : "Hide Sidebar")">
            @(_sidebarCollapsed ? "â–¶" : "â—€")
        </button>

        <div class="sidebar-content">
            <div class="statistics-panel">
                <h3>âš™ï¸ Settings</h3>

                <div class="stat-item">
                    <span class="stat-label">Algorithm</span>
                    <select @bind="SelectedAlgorithm" @bind:after="OnAlgorithmChanged" style="width: 100%;">
                        @if (string.IsNullOrEmpty(SelectedCategory))
                        {
                            @foreach (var group in GetAlgorithmsByCategory())
                            {
                                <optgroup label="@group.Key">
                                    @foreach (var algo in group)
                                    {
                                        <option value="@algo.Name">@algo.Name</option>
                                    }
                                </optgroup>
                            }
                        }
                        else
                        {
                            @foreach (var algo in GetFilteredAlgorithms())
                            {
                                <option value="@algo.Name">@algo.Name</option>
                            }
                        }
                    </select>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Array Size @GetSizeRecommendation()</span>
                    <select @bind="ArraySize">
                        @foreach (var size in AvailableSizes)
                        {
                            <option value="@size">@size @(IsRecommendedSize(size) ? "â­" : "")</option>
                        }
                    </select>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Array Pattern</span>
                    <select @bind="SelectedPattern" style="width: 100%;">
                        @foreach (ArrayPattern pattern in Enum.GetValues(typeof(ArrayPattern)))
                        {
                            <option value="@pattern">@PatternGenerator.GetDisplayName(pattern)</option>
                        }
                    </select>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Visualization Mode</span>
                    <select @bind="SelectedVisualizationMode" @bind:after="OnVisualizationModeChanged" style="width: 100%;">
                        <option value="@VisualizationMode.BarChart">ğŸ“Š Bar Chart</option>
                        <option value="@VisualizationMode.Circular">â­• Circular</option>
                    </select>
                </div>

                <div class="stat-item">
                    <button class="primary" @onclick="GenerateAndSort" style="width: 100%;">ğŸ² Generate & Sort</button>
                </div>


            <div class="stat-item">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="Playback.AutoReset" />
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Auto Reset on Complete</span>
                </label>
            </div>
            
            <div class="stat-item">
                <label class="toggle-switch">
                    <input type="checkbox" @bind="Playback.InstantMode" />
                    <span class="toggle-slider"></span>
                    <span class="toggle-label">Instant Mode (No Animation)</span>
                </label>
            </div>
            
            <div class="stat-item stat-item-vertical">
                    <span class="stat-label">Operations Per Frame</span>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span class="stat-value" style="font-size: 0.9rem;">@Playback.OperationsPerFrame ops/frame</span>
                    </div>
                    <input type="range" min="1" max="1000" @bind="Playback.OperationsPerFrame" @bind:after="StateHasChanged" style="width: 100%;" />
                </div>

            <div class="stat-item stat-item-vertical">
                <span class="stat-label">Speed Multiplier</span>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <span class="stat-value" style="font-size: 0.9rem;">@Playback.SpeedMultiplier.ToString("F1")x</span>
                    <span style="font-size: 0.85rem; color: #999;">(@EffectiveFPS FPS)</span>
                </div>
                <input type="range" min="0.5" max="100" step="0.5" @bind="Playback.SpeedMultiplier" @bind:after="StateHasChanged" style="width: 100%;" />
            </div>
            </div>

            <StatisticsPanel State="Playback.State" />

            <div class="stat-item" style="margin-top: 20px;">
                <span class="stat-label">Complexity</span>
                <span class="stat-value" style="font-size: 0.9rem;">@GetSelectedAlgorithmComplexity()</span>
            </div>
        </div>
    </div>

    <div class="visualization-area">
        <div class="visualization-content">
            @if (_isComparisonMode && ComparisonMode.State.Instances.Any())
            {
                @* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰: ã‚°ãƒªãƒƒãƒ‰è¡¨ç¤º *@
                <ComparisonGrid 
                    Instances="ComparisonMode.State.Instances"
                    VisualizationMode="SelectedVisualizationMode" />
            }
            else if (Playback.State.MainArray.Length > 0)
            {
                @* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰: å˜ä¸€ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ è¡¨ç¤º *@
                @if (Playback.State.Mode == VisualizationMode.BarChart)
                {
                    <CanvasChartRenderer State="Playback.State"
                                      OnClick="OnVisualizationClick" />
                }
                else if (Playback.State.Mode == VisualizationMode.Circular)
                {
                    <CircularRenderer State="Playback.State"
                                   OnClick="OnVisualizationClick" />
                }
            }
            else
            {
                <div style="text-align: center; color: #999;">
                    <p style="font-size: 2rem;">@(Playback.State.Mode == VisualizationMode.Circular ? "â­•" : "ğŸ“Š")</p>
                    <p>Click "Generate & Sort" to start visualization</p>
                </div>
            }
        </div>
    </div>

    <div class="controls">
        @if (_isComparisonMode && ComparisonMode.State.Instances.Any())
        {
            @* æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼ˆå®Ÿè£…ã¯å¾Œã§ï¼‰ *@
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button @onclick="ComparisonMode.Reset">â¹ Reset</button>
                <button @onclick="ToggleComparisonPlayPause">
                    @(_isComparisonPlaying ? "â¸ Pause" : "â–¶ Play")
                </button>
                <span style="flex: 1;"></span>
                <span style="color: #999;">Comparing @ComparisonMode.State.Instances.Count algorithms</span>
            </div>
        }
        else
        {
            @* é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« *@
            <SeekBar CurrentIndex="Playback.State.CurrentOperationIndex"
                     TotalOperations="Playback.State.TotalOperations"
                     OnSeek="OnSeek" />

            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button @onclick="Playback.Stop">â¹ Reset</button>
                <button @onclick="Playback.TogglePlayPause">
                    @(Playback.State.PlaybackState == PlaybackState.Playing ? "â¸ Pause" : "â–¶ Play")
                </button>
                <span style="flex: 1;"></span>
                <span style="color: #999;">Mode: @Playback.State.Mode</span>
            </div>
        }
    </div>
</div>

@code {
private string SelectedAlgorithm { get; set; } = "Bubble sort";
private string SelectedCategory { get; set; } = "";
private int ArraySize { get; set; } = 64;
private ArrayPattern SelectedPattern { get; set; } = ArrayPattern.Random;
private VisualizationMode SelectedVisualizationMode { get; set; } = VisualizationMode.BarChart;
private string _runningAlgorithmName = string.Empty;

    // æ¯”è¼ƒãƒ¢ãƒ¼ãƒ‰é–¢é€£
    private bool _isComparisonMode = false;
    private string _selectedAlgorithmToAdd = "Bubble sort";
    private bool _isComparisonPlaying = false;

    private int[] AvailableSizes = [8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096];

    private int EffectiveFPS => (int)(60 * Playback.SpeedMultiplier);

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãƒªã‚µã‚¤ã‚ºé–¢é€£
    private int _sidebarWidth = 280; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¹…ï¼ˆpxï¼‰
    private bool _sidebarCollapsed = false; // æŠ˜ã‚ŠãŸãŸã¿çŠ¶æ…‹
    private bool _isResizing = false;
    private int _resizeStartX = 0;
    private int _resizeStartWidth = 0;

    protected override void OnInitialized()
    {
        Playback.StateChanged += OnStateChanged;
        // åˆæœŸã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã®æ¨å¥¨ã‚µã‚¤ã‚ºã‚’è¨­å®š
        SetRecommendedSize();
        // åˆæœŸãƒ¢ãƒ¼ãƒ‰ã‚’åŒæœŸ
        SelectedVisualizationMode = Playback.State.Mode;
    }

    private void ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
        StateHasChanged();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // ã‚°ãƒ­ãƒ¼ãƒãƒ«ãªãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ç™»éŒ²ï¼ˆJS Interopä¸è¦ã€Blazorå´ã§å‡¦ç†ï¼‰
        }
    }

    private void StartResize(MouseEventArgs e)
    {
        _isResizing = true;
        _resizeStartX = (int)e.ClientX;
        _resizeStartWidth = _sidebarWidth;
    }

    private void OnMouseMove(MouseEventArgs e)
    {
        if (_isResizing)
        {
            var deltaX = (int)e.ClientX - _resizeStartX;
            var newWidth = _resizeStartWidth + deltaX;

            // æœ€å°200pxã€æœ€å¤§500pxã«åˆ¶é™
            _sidebarWidth = Math.Clamp(newWidth, 200, 500);
            StateHasChanged();
        }
    }

    private void OnMouseUp()
    {
        _isResizing = false;
    }

    private void OnAlgorithmChanged()
    {
        SetRecommendedSize();
        StateHasChanged();
    }

    private void SetRecommendedSize()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (algo != null)
        {
            ArraySize = algo.RecommendedSize;
        }
    }

    private string GetSizeRecommendation()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (algo != null && algo.RecommendedSize != ArraySize)
        {
            return $"(Recommended: {algo.RecommendedSize})";
        }
        return "";
    }

    private bool IsRecommendedSize(int size)
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        return algo?.RecommendedSize == size;
    }

    private IEnumerable<AlgorithmMetadata> GetFilteredAlgorithms()
    {
        var algorithms = string.IsNullOrEmpty(SelectedCategory)
            ? Registry.GetAllAlgorithms()
            : Registry.GetByCategory(SelectedCategory);

        return algorithms;
    }

    private IEnumerable<IGrouping<string, AlgorithmMetadata>> GetAlgorithmsByCategory()
    {
        // AlgorithmRegistry ã«ç™»éŒ²ã•ã‚ŒãŸé †åºã‚’ä¿æŒã—ãªãŒã‚‰ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        var allAlgorithms = Registry.GetAllAlgorithms();
        
        // ã‚«ãƒ†ã‚´ãƒªã®æœ€åˆã®å‡ºç¾é †åºã‚’è¨˜éŒ²
        var categoryOrder = allAlgorithms
            .Select((algo, index) => new { algo.Category, Index = index })
            .GroupBy(x => x.Category)
            .ToDictionary(g => g.Key, g => g.Min(x => x.Index));
        
        // ã‚«ãƒ†ã‚´ãƒªã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€ã‚«ãƒ†ã‚´ãƒªã®æœ€åˆã®å‡ºç¾é †ã§ã‚½ãƒ¼ãƒˆ
        return allAlgorithms
            .GroupBy(a => a.Category)
            .OrderBy(g => categoryOrder[g.Key]);
    }

    private string GetSelectedAlgorithmComplexity()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        return algo?.TimeComplexity ?? "Unknown";
    }

    private void GenerateAndSort()
    {
        var metadata = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (metadata == null)
        {
            Console.WriteLine($"Algorithm not found: {SelectedAlgorithm}");
            return;
        }

        // Update running algorithm name when sort is actually executed
        _runningAlgorithmName = SelectedAlgorithm;

        // è¦ç´ æ•°åˆ¶é™ã‚’é©ç”¨ï¼ˆã™ã¹ã¦ã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã§4096ã¾ã§å¯¾å¿œï¼‰
        var size = Math.Min(ArraySize, metadata.MaxElements);

        // é¸æŠã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã§é…åˆ—ç”Ÿæˆ
        var array = PatternGenerator.Generate(size, SelectedPattern);

        // ã‚½ãƒ¼ãƒˆå®Ÿè¡Œã¨æ“ä½œè¨˜éŒ²ï¼ˆReadOnlySpanã‚’ä½¿ç”¨ï¼‰
        try
        {
            var operations = Executor.ExecuteAndRecord(array.AsSpan(), metadata);
            Playback.LoadOperations(array.AsSpan(), operations);
            Console.WriteLine($"Loaded {operations.Count} operations for {SelectedAlgorithm} with {PatternGenerator.GetDisplayName(SelectedPattern)} pattern");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error executing sort: {ex.Message}");
        }
    }

    private void OnVisualizationClick()
    {
        Playback.TogglePlayPause();
    }

    private void OnSeek(int index)
    {
        // ãƒ‰ãƒ©ãƒƒã‚°ä¸­ã®ã‚·ãƒ¼ã‚¯ã¯ã‚¹ãƒ­ãƒƒãƒˆãƒªãƒ³ã‚°ã‚’æœ‰åŠ¹åŒ–
        Playback.SeekTo(index, throttle: true);
    }

    private void OnVisualizationModeChanged()
    {
        Playback.State.Mode = SelectedVisualizationMode;
        StateHasChanged();
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleComparisonPlayPause()
    {
        if (_isComparisonPlaying)
        {
            ComparisonMode.Pause();
            _isComparisonPlaying = false;
        }
        else
        {
            ComparisonMode.Play();
            _isComparisonPlaying = true;
        }
        StateHasChanged();
    }


    public void Dispose()
    {
        Playback.StateChanged -= OnStateChanged;
    }
}

