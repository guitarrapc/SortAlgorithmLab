@page "/"
@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services
@using SortAlgorithm.VisualizationWeb.Components
@inject PlaybackService Playback
@inject SortExecutor Executor
@inject AlgorithmRegistry Registry
@inject ArrayPatternGenerator PatternGenerator
@inject ComparisonModeService ComparisonMode
@inject DebugSettings DebugSettings
@implements IDisposable

<PageTitle>Sort Algorithm Visualization</PageTitle>

<div class="visualization-page"
     style="--sidebar-width: @(_sidebarCollapsed ? "40" : _sidebarWidth)px; user-select: @(_isResizing ? "none" : "auto");"
     @onmousemove="OnMouseMove"
     @onmouseup="OnMouseUp"
     @onmousemove:preventDefault="@_isResizing">
    <div class="header">
        <h1>
            üé® Sort Algorithm Visualization
            @if (!string.IsNullOrEmpty(_runningAlgorithmName))
            {
                <span style="font-size: 0.6em; color: #888; margin-left: 1em;">- @_runningAlgorithmName</span>
            }
        </h1>
        <div style="display: flex; align-items: center; gap: 1rem;">
            <label class="toggle-switch" style="display: flex; align-items: center; gap: 0.5rem;">
                <span style="font-size: 0.9em; color: #999;">üêõ Debug Log</span>
                <input type="checkbox" @bind="DebugSettings.IsEnabled" @bind:after="OnDebugToggleChanged" />
                <span class="toggle-slider"></span>
            </label>
            <select @bind="SelectedCategory">
                <option value="">All Categories</option>
                @foreach (var category in Registry.GetCategories())
                {
                    <option value="@category">@category</option>
                }
            </select>
        </div>
    </div>

    <div class="sidebar @(_sidebarCollapsed ? "collapsed" : "")">
        <div class="sidebar-resizer"
             @onmousedown="StartResize"
             @onmousedown:preventDefault></div>

        <button class="sidebar-toggle"
                @onclick="ToggleSidebar"
                title="@(_sidebarCollapsed ? "Show Sidebar" : "Hide Sidebar")">
            @(_sidebarCollapsed ? "‚ñ∂" : "‚óÄ")
        </button>

        <div class="sidebar-content">
            <div class="statistics-panel">
                <h3>‚öôÔ∏è Settings</h3>

                <div class="stat-item">
                    <span class="stat-label">Algorithm</span>
                    <select @bind="SelectedAlgorithm" @bind:after="OnAlgorithmChanged" style="width: 100%;">
                        @if (string.IsNullOrEmpty(SelectedCategory))
                        {
                            @foreach (var group in GetAlgorithmsByCategory())
                            {
                                <optgroup label="@group.Key">
                                    @foreach (var algo in group)
                                    {
                                        <option value="@algo.Name">@algo.Name</option>
                                    }
                                </optgroup>
                            }
                        }
                        else
                        {
                            @foreach (var algo in GetFilteredAlgorithms())
                            {
                                <option value="@algo.Name">@algo.Name</option>
                            }
                        }
                    </select>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Array Size @GetSizeRecommendation()</span>
                    <select @bind="ArraySize">
                        @foreach (var size in AvailableSizes)
                        {
                            <option value="@size">@size @(IsRecommendedSize(size) ? "‚≠ê" : "")</option>
                        }
                    </select>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Array Pattern</span>
                    <select @bind="SelectedPattern" style="width: 100%;">
                        @foreach (ArrayPattern pattern in Enum.GetValues(typeof(ArrayPattern)))
                        {
                            <option value="@pattern">@PatternGenerator.GetDisplayName(pattern)</option>
                        }
                    </select>
                </div>

                <div class="stat-item">
                    <span class="stat-label">Visualization Mode</span>
                    <select @bind="SelectedVisualizationMode" @bind:after="OnVisualizationModeChanged" style="width: 100%;">
                        <option value="@VisualizationMode.BarChart">üìä Bar Chart</option>
                        <option value="@VisualizationMode.Circular">‚≠ï Circular</option>
                    </select>
                </div>


                <div class="stat-item">
                    <span class="stat-label">
                        Comparison Mode
                        <span style="font-size: 0.8em; color: #888;">
                            (@(ComparisonMode.State.Instances.Count)/@(ComparisonState.MaxComparisons))
                        </span>
                    </span>
                    <label class="toggle-switch">
                        <input type="checkbox" @bind="_isComparisonMode" @bind:after="OnComparisonModeChanged" />
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="stat-item">
                    @if (_isComparisonMode)
                    {
                        var isDisabled = ComparisonMode.State.Instances.Count >= ComparisonState.MaxComparisons || !ComparisonMode.State.IsEnabled;
                        <button class="primary" 
                                @onclick="AddAlgorithmToComparison" 
                                style="width: 100%;"
                                disabled="@isDisabled">
                            ‚ûï Add to Comparison
                        </button>
                    }
                    else
                    {
                        <button class="primary" @onclick="GenerateAndSort" style="width: 100%;">üé≤ Generate & Sort</button>
                    }
                </div>

                                <div class="stat-item stat-item-vertical">
                        <span class="stat-label">Operations Per Frame</span>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span class="stat-value" style="font-size: 0.9rem;">@Playback.OperationsPerFrame ops/frame</span>
                        </div>
                        <input type="range" min="1" max="1000" @bind="Playback.OperationsPerFrame" @bind:after="OnSpeedSettingsChanged" style="width: 100%;" />
                    </div>

                <div class="stat-item stat-item-vertical">
                    <span class="stat-label">Speed Multiplier</span>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span class="stat-value" style="font-size: 0.9rem;">@Playback.SpeedMultiplier.ToString("F1")x</span>
                        <span style="font-size: 0.85rem; color: #999;">(@EffectiveFPS FPS)</span>
                    </div>
                    <input type="range" min="0.5" max="100" step="0.5" @bind="Playback.SpeedMultiplier" @bind:after="OnSpeedSettingsChanged" style="width: 100%;" />
                </div>

            @if (!_isComparisonMode)
            {
                <div class="stat-item">
                    <label class="toggle-switch">
                        <input type="checkbox" @bind="Playback.AutoReset" />
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Auto Reset on Complete</span>
                    </label>
                </div>
                
                <div class="stat-item">
                    <label class="toggle-switch">
                        <input type="checkbox" @bind="Playback.InstantMode" />
                        <span class="toggle-slider"></span>
                        <span class="toggle-label">Instant Mode (No Animation)</span>
                    </label>
                </div>                
            }
            </div>

            @if (!_isComparisonMode)
            {
                <StatisticsPanel State="Playback.State" />

                <div class="stat-item" style="margin-top: 20px;">
                    <span class="stat-label">Complexity</span>
                    <span class="stat-value" style="font-size: 0.9rem;">@GetSelectedAlgorithmComplexity()</span>
                </div>
            }
        </div>
    </div>

    <div class="visualization-area">
        <div class="visualization-content">
            @if (_isComparisonMode && ComparisonMode.State.Instances.Any())
            {
                @* ÊØîËºÉ„É¢„Éº„Éâ: „Ç∞„É™„ÉÉ„ÉâË°®Á§∫ *@
                <ComparisonGrid 
                    Instances="ComparisonMode.State.Instances"
                    VisualizationMode="SelectedVisualizationMode"
                    OnRemove="RemoveAlgorithmFromComparison"
                    OnVisualizationClick="OnComparisonVisualizationClick" />
            }
            else if (Playback.State.MainArray.Length > 0)
            {
                @* ÈÄöÂ∏∏„É¢„Éº„Éâ: Âçò‰∏Ä„Ç¢„É´„Ç¥„É™„Ç∫„É†Ë°®Á§∫ *@
                @if (Playback.State.Mode == VisualizationMode.BarChart)
                {
                    <CanvasChartRenderer State="Playback.State"
                                      OnClick="OnVisualizationClick" />
                }
                else if (Playback.State.Mode == VisualizationMode.Circular)
                {
                    <CircularRenderer State="Playback.State"
                                   OnClick="OnVisualizationClick" />
                }
            }
            else
            {
                <div style="text-align: center; color: #999;">
                    <p style="font-size: 2rem;">@(Playback.State.Mode == VisualizationMode.Circular ? "‚≠ï" : "üìä")</p>
                    <p>Click "Generate & Sort" to start visualization</p>
                </div>
            }
        </div>
    </div>
    
    @* Áµ±Ë®àÊØîËºÉË°®ÔºàÂè≥ÂÅ¥„Éâ„ÉÉ„Ç≠„É≥„Ç∞„Éë„Éç„É´Ôºâ *@
    @if (_isComparisonMode && ComparisonMode.State.Instances.Any())
    {
        <ComparisonStatsTable 
            Instances="ComparisonMode.State.Instances"
            @bind-IsOpen="_statsTableOpen" />
    }

    <div class="controls">
        @if (_isComparisonMode && ComparisonMode.State.Instances.Any())
        {
            @* ÊØîËºÉ„É¢„Éº„ÉâÁî®„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´ *@
            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button @onclick="ComparisonMode.Reset">‚èπ Reset</button>
                <button @onclick="ToggleComparisonPlayPause">
                    @(_isComparisonPlaying ? "‚è∏ Pause" : "‚ñ∂ Play")
                </button>
                
                <span style="flex: 1;"></span>
                
                @* ÂÆå‰∫ÜÁä∂ÊÖã„ÅÆË°®Á§∫ *@
                @if (ComparisonMode.State.AllCompleted)
                {
                    <span style="color: #10B981; font-weight: bold;">‚úÖ All Completed!</span>
                }
                else
                {
                    var completedCount = ComparisonMode.State.Instances.Count(x => x.State.IsSortCompleted);
                    <span style="color: #999;">
                        @if (completedCount > 0)
                        {
                            <span style="color: #F59E0B;">@completedCount/@ComparisonMode.State.Instances.Count completed</span>
                        }
                        else
                        {
                            <span>Comparing @ComparisonMode.State.Instances.Count algorithms</span>
                        }
                    </span>
                }
            </div>
        }
        else
        {
            @* ÈÄöÂ∏∏„É¢„Éº„ÉâÁî®„ÅÆ„Ç≥„É≥„Éà„É≠„Éº„É´ *@
            <SeekBar CurrentIndex="Playback.State.CurrentOperationIndex"
                     TotalOperations="Playback.State.TotalOperations"
                     OnSeek="OnSeek" />

            <div style="display: flex; gap: 10px; margin-top: 10px; align-items: center;">
                <button @onclick="Playback.Stop">‚èπ Reset</button>
                <button @onclick="Playback.TogglePlayPause">
                    @(Playback.State.PlaybackState == PlaybackState.Playing ? "‚è∏ Pause" : "‚ñ∂ Play")
                </button>
                <span style="flex: 1;"></span>
                <span style="color: #999;">Mode: @Playback.State.Mode</span>
            </div>
        }
    </div>
</div>

@code {
private string SelectedAlgorithm { get; set; } = "Bubble sort";
private string SelectedCategory { get; set; } = "";
private int ArraySize { get; set; } = 64;
private ArrayPattern SelectedPattern { get; set; } = ArrayPattern.Random;
private VisualizationMode SelectedVisualizationMode { get; set; } = VisualizationMode.BarChart;
private string _runningAlgorithmName = string.Empty;

    // ÊØîËºÉ„É¢„Éº„ÉâÈñ¢ÈÄ£
    private bool _isComparisonMode = false;
    private bool _isComparisonPlaying = false;
    private bool _statsTableOpen = false;

    private int[] AvailableSizes = [8, 16, 32, 64, 128, 256, 512, 1024, 2048, 4096];

    private int EffectiveFPS => (int)(60 * Playback.SpeedMultiplier);

    // „Çµ„Ç§„Éâ„Éê„Éº„É™„Çµ„Ç§„Ç∫Èñ¢ÈÄ£
    private int _sidebarWidth = 280; // „Éá„Éï„Ç©„É´„ÉàÂπÖÔºàpxÔºâ
    private bool _sidebarCollapsed = false; // Êäò„Çä„Åü„Åü„ÅøÁä∂ÊÖã
    private bool _isResizing = false;
    private int _resizeStartX = 0;
    private int _resizeStartWidth = 0;

    protected override void OnInitialized()
    {
        Playback.StateChanged += OnStateChanged;
        ComparisonMode.OnStateChanged += OnStateChanged; // ÊØîËºÉ„É¢„Éº„Éâ„ÅÆÁä∂ÊÖãÂ§âÊõ¥„ÇíË≥ºË™≠
        DebugSettings.OnChanged += OnStateChanged; // „Éá„Éê„ÉÉ„Ç∞Ë®≠ÂÆö„ÅÆÂ§âÊõ¥„ÇíË≥ºË™≠
        
        // ÂàùÊúü„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅÆÊé®Â•®„Çµ„Ç§„Ç∫„ÇíË®≠ÂÆö
        SetRecommendedSize();
        // ÂàùÊúü„É¢„Éº„Éâ„ÇíÂêåÊúü
        SelectedVisualizationMode = Playback.State.Mode;
    }

    private void ToggleSidebar()
    {
        _sidebarCollapsed = !_sidebarCollapsed;
        StateHasChanged();
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // „Ç∞„É≠„Éº„Éê„É´„Å™„Éû„Ç¶„Çπ„Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÇíÁôªÈå≤ÔºàJS Interop‰∏çË¶Å„ÄÅBlazorÂÅ¥„ÅßÂá¶ÁêÜÔºâ
        }
    }

    private void StartResize(MouseEventArgs e)
    {
        _isResizing = true;
        _resizeStartX = (int)e.ClientX;
        _resizeStartWidth = _sidebarWidth;
    }

    private void OnMouseMove(MouseEventArgs e)
    {
        if (_isResizing)
        {
            var deltaX = (int)e.ClientX - _resizeStartX;
            var newWidth = _resizeStartWidth + deltaX;

            // ÊúÄÂ∞è200px„ÄÅÊúÄÂ§ß500px„Å´Âà∂Èôê
            _sidebarWidth = Math.Clamp(newWidth, 200, 500);
            StateHasChanged();
        }
    }

    private void OnMouseUp()
    {
        _isResizing = false;
    }

    private void OnDebugToggleChanged()
    {
        StateHasChanged();
    }

    private void OnAlgorithmChanged()
    {
        SetRecommendedSize();
        StateHasChanged();
    }

    private void SetRecommendedSize()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (algo != null)
        {
            ArraySize = algo.RecommendedSize;
        }
    }

    private string GetSizeRecommendation()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (algo != null && algo.RecommendedSize != ArraySize)
        {
            return $"(Recommended: {algo.RecommendedSize})";
        }
        return "";
    }

    private bool IsRecommendedSize(int size)
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        return algo?.RecommendedSize == size;
    }

    private IEnumerable<AlgorithmMetadata> GetFilteredAlgorithms()
    {
        var algorithms = string.IsNullOrEmpty(SelectedCategory)
            ? Registry.GetAllAlgorithms()
            : Registry.GetByCategory(SelectedCategory);

        return algorithms;
    }

    private IEnumerable<IGrouping<string, AlgorithmMetadata>> GetAlgorithmsByCategory()
    {
        // AlgorithmRegistry „Å´ÁôªÈå≤„Åï„Çå„ÅüÈ†ÜÂ∫è„Çí‰øùÊåÅ„Åó„Å™„Åå„Çâ„Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ
        var allAlgorithms = Registry.GetAllAlgorithms();
        
        // „Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂàù„ÅÆÂá∫ÁèæÈ†ÜÂ∫è„ÇíË®òÈå≤
        var categoryOrder = allAlgorithms
            .Select((algo, index) => new { algo.Category, Index = index })
            .GroupBy(x => x.Category)
            .ToDictionary(g => g.Key, g => g.Min(x => x.Index));
        
        // „Ç´„ÉÜ„Ç¥„É™„Åî„Å®„Å´„Ç∞„É´„Éº„ÉóÂåñ„Åó„ÄÅ„Ç´„ÉÜ„Ç¥„É™„ÅÆÊúÄÂàù„ÅÆÂá∫ÁèæÈ†Ü„Åß„ÇΩ„Éº„Éà
        return allAlgorithms
            .GroupBy(a => a.Category)
            .OrderBy(g => categoryOrder[g.Key]);
    }

    private string GetSelectedAlgorithmComplexity()
    {
        var algo = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        return algo?.TimeComplexity ?? "Unknown";
    }

    private void GenerateAndSort()
    {
        var metadata = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (metadata == null)
        {
            DebugSettings.Log($"Algorithm not found: {SelectedAlgorithm}");
            return;
        }

        // Update running algorithm name when sort is actually executed
        _runningAlgorithmName = SelectedAlgorithm;

        // Ë¶ÅÁ¥†Êï∞Âà∂Èôê„ÇíÈÅ©Áî®Ôºà„Åô„Åπ„Å¶„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Åß4096„Åæ„ÅßÂØæÂøúÔºâ
        var size = Math.Min(ArraySize, metadata.MaxElements);

        // ÈÅ∏Êäû„Åï„Çå„Åü„Éë„Çø„Éº„É≥„ÅßÈÖçÂàóÁîüÊàê
        var array = PatternGenerator.Generate(size, SelectedPattern);

        // „ÇΩ„Éº„ÉàÂÆüË°å„Å®Êìç‰ΩúË®òÈå≤ÔºàReadOnlySpan„Çí‰ΩøÁî®Ôºâ
        try
        {
            var operations = Executor.ExecuteAndRecord(array.AsSpan(), metadata);
            Playback.LoadOperations(array.AsSpan(), operations);
            DebugSettings.Log($"Loaded {operations.Count} operations for {SelectedAlgorithm} with {PatternGenerator.GetDisplayName(SelectedPattern)} pattern");
        }
        catch (Exception ex)
        {
            DebugSettings.Log($"Error executing sort: {ex.Message}");
        }
    }

    // ÊØîËºÉ„É¢„Éº„ÉâÈñ¢ÈÄ£„É°„ÇΩ„ÉÉ„Éâ
    private void OnComparisonModeChanged()
    {
        DebugSettings.Log($"[OnComparisonModeChanged] Called. _isComparisonMode: {_isComparisonMode}");
        
        if (_isComparisonMode)
        {
            // ÊØîËºÉ„É¢„Éº„ÉâON: ÂàùÊúüÈÖçÂàó„ÇíÁîüÊàê„Åó„Å¶Ë®≠ÂÆö
            var size = Math.Min(ArraySize, 4096);
            DebugSettings.Log($"[OnComparisonModeChanged] Generating array of size: {size} with pattern: {SelectedPattern}");
            var array = PatternGenerator.Generate(size, SelectedPattern);
            DebugSettings.Log($"[OnComparisonModeChanged] Generated array length: {array.Length}");
            
            ComparisonMode.Enable(array, size, SelectedPattern);
            
            // „Çµ„Ç§„Éâ„Éê„Éº„ÅÆÈÄüÂ∫¶Ë®≠ÂÆö„ÇíÊØîËºÉ„É¢„Éº„Éâ„Å´ÈÅ©Áî®
            ComparisonMode.SetSpeedForAll(Playback.OperationsPerFrame, Playback.SpeedMultiplier);
            
            DebugSettings.Log($"[OnComparisonModeChanged] Comparison mode enabled with {SelectedPattern} pattern");
        }
        else
        {
            // ÊØîËºÉ„É¢„Éº„ÉâOFF: „ÇØ„É™„Éº„É≥„Ç¢„ÉÉ„Éó
            ComparisonMode.Disable();
            _runningAlgorithmName = string.Empty;
            DebugSettings.Log("Comparison mode disabled");
        }
        StateHasChanged();
    }



    private void AddAlgorithmToComparison()
    {
        DebugSettings.Log($"[Index] AddAlgorithmToComparison called");
        DebugSettings.Log($"[Index] _isComparisonMode: {_isComparisonMode}");
        DebugSettings.Log($"[Index] ComparisonMode.State.IsEnabled: {ComparisonMode.State.IsEnabled}");
        DebugSettings.Log($"[Index] ComparisonMode.State.CurrentArraySize: {ComparisonMode.State.CurrentArraySize}");
        DebugSettings.Log($"[Index] ComparisonMode.State.CurrentPattern: {ComparisonMode.State.CurrentPattern}");
        DebugSettings.Log($"[Index] Current ArraySize: {ArraySize}");
        DebugSettings.Log($"[Index] Current Pattern: {SelectedPattern}");
        DebugSettings.Log($"[Index] Existing instances count: {ComparisonMode.State.Instances.Count}");
        foreach (var inst in ComparisonMode.State.Instances)
        {
            DebugSettings.Log($"[Index]   - {inst.AlgorithmName}: {inst.State.MainArray.Length} elements");
        }

        // üîß Array Size„Åæ„Åü„ÅØPattern„ÅåÂ§âÊõ¥„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÄÅÊó¢Â≠ò„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÇíÊñ∞„Åó„ÅÑË®≠ÂÆö„ÅßÂÜçÂÆüË°å
        var currentSize = Math.Min(ArraySize, 4096);
        var needRegeneration = ComparisonMode.State.CurrentArraySize != currentSize 
                            || ComparisonMode.State.CurrentPattern != SelectedPattern;
        
        DebugSettings.Log($"[Index] NeedRegeneration: {needRegeneration} (size: {ComparisonMode.State.CurrentArraySize} vs {currentSize}, pattern: {ComparisonMode.State.CurrentPattern} vs {SelectedPattern})");
        
        if (needRegeneration && ComparisonMode.State.Instances.Any())
        {
            DebugSettings.Log($"[Index] ‚úÖ Settings changed - regenerating all existing algorithms");
            DebugSettings.Log($"[Index]    Old: size={ComparisonMode.State.CurrentArraySize}, pattern={ComparisonMode.State.CurrentPattern}");
            DebugSettings.Log($"[Index]    New: size={currentSize}, pattern={SelectedPattern}");
            
            // Êó¢Â≠ò„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†ÊÉÖÂ†±„Çí‰øùÂ≠ò
            var existingAlgorithms = ComparisonMode.State.Instances
                .Select(i => new { i.AlgorithmName, i.Metadata })
                .ToList();
            
            DebugSettings.Log($"[Index] Saved {existingAlgorithms.Count} existing algorithms");
            
            // Êñ∞„Åó„ÅÑÈÖçÂàó„ÇíÁîüÊàê
            var newArray = PatternGenerator.Generate(currentSize, SelectedPattern);
            DebugSettings.Log($"[Index] Generated new array: {newArray.Length} elements with pattern {SelectedPattern}");
            
            ComparisonMode.Enable(newArray, currentSize, SelectedPattern);
            DebugSettings.Log($"[Index] Called Enable() - instances should be cleared now");
            
            // „Åô„Åπ„Å¶„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÇíÊñ∞„Åó„ÅÑË®≠ÂÆö„ÅßÂÜçËøΩÂä†
            foreach (var algo in existingAlgorithms)
            {
                ComparisonMode.AddAlgorithm(algo.AlgorithmName, algo.Metadata);
                DebugSettings.Log($"[Index] Re-added {algo.AlgorithmName} with new settings");
                
                // ËøΩÂä†Áõ¥Âæå„Å´ÈÄüÂ∫¶Ë®≠ÂÆö„ÇíÈÅ©Áî®
                ComparisonMode.SetSpeedForAll(Playback.OperationsPerFrame, Playback.SpeedMultiplier);
            }
            
            DebugSettings.Log($"[Index] After re-adding, instances count: {ComparisonMode.State.Instances.Count}");
        }
        else if (needRegeneration)
        {
            DebugSettings.Log($"[Index] ‚ö†Ô∏è No existing instances, just updating settings");
            
            // „Ç¢„É´„Ç¥„É™„Ç∫„É†„Åå„Åæ„Å†„Å™„ÅÑÂ†¥Âêà„ÅØ„ÄÅÂçòÁ¥î„Å´Ë®≠ÂÆö„ÇíÊõ¥Êñ∞
            var newArray = PatternGenerator.Generate(currentSize, SelectedPattern);
            ComparisonMode.Enable(newArray, currentSize, SelectedPattern);
            
            // ÈÄüÂ∫¶Ë®≠ÂÆö„ÇíÂÜçÈÅ©Áî®Ôºà„Éë„Çø„Éº„É≥Â§âÊõ¥Âæå„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Çã„ÅÆ„ÇíÈò≤„ÅêÔºâ
            ComparisonMode.SetSpeedForAll(Playback.OperationsPerFrame, Playback.SpeedMultiplier);
        }
        else
        {
            DebugSettings.Log($"[Index] ‚ÑπÔ∏è Settings unchanged, using existing configuration");
        }

        // ÁèæÂú®ÈÅ∏Êäû‰∏≠„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÇíËøΩÂä†
        var metadata = Registry.GetAllAlgorithms().FirstOrDefault(a => a.Name == SelectedAlgorithm);
        if (metadata == null)
        {
            DebugSettings.Log($"[Index] Algorithm not found: {SelectedAlgorithm}");
            return;
        }

        // „Åô„Åß„Å´ËøΩÂä†Ê∏à„Åø„Åã„ÉÅ„Çß„ÉÉ„ÇØ
        if (ComparisonMode.State.Instances.Any(x => x.AlgorithmName == SelectedAlgorithm))
        {
            DebugSettings.Log($"[Index] {SelectedAlgorithm} is already in comparison");
            return;
        }

        DebugSettings.Log($"[Index] Adding new algorithm: {SelectedAlgorithm}");
        ComparisonMode.AddAlgorithm(SelectedAlgorithm, metadata);
        DebugSettings.Log($"[Index] After adding, instances count: {ComparisonMode.State.Instances.Count}");
        
        // Êñ∞„Åó„ÅèËøΩÂä†„Åó„Åü„Ç¢„É´„Ç¥„É™„Ç∫„É†„Å´„ÇÇÈÄüÂ∫¶Ë®≠ÂÆö„ÇíÈÅ©Áî®
        ComparisonMode.SetSpeedForAll(Playback.OperationsPerFrame, Playback.SpeedMultiplier);
        DebugSettings.Log($"[Index] Applied speed settings to new algorithm: OperationsPerFrame={Playback.OperationsPerFrame}, SpeedMultiplier={Playback.SpeedMultiplier}");
        
        StateHasChanged();
    }

    private void RemoveAlgorithmFromComparison(int index)
    {
        DebugSettings.Log($"[Index] RemoveAlgorithmFromComparison called for index: {index}");
        DebugSettings.Log($"[Index] Before removal, instances count: {ComparisonMode.State.Instances.Count}");
        
        if (index >= 0 && index < ComparisonMode.State.Instances.Count)
        {
            var algorithmName = ComparisonMode.State.Instances[index].AlgorithmName;
            DebugSettings.Log($"[Index] Removing algorithm: {algorithmName}");
        }
        
        ComparisonMode.RemoveAlgorithm(index);
        
        DebugSettings.Log($"[Index] After removal, instances count: {ComparisonMode.State.Instances.Count}");
        StateHasChanged();
    }

    private void OnVisualizationClick()
    {
        Playback.TogglePlayPause();
    }

    private void OnComparisonVisualizationClick()
    {
        // ÊØîËºÉ„É¢„Éº„ÉâÊôÇÔºö„ÇØ„É™„ÉÉ„ÇØ„Åß„Åô„Åπ„Å¶„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Çí„Éà„Ç∞„É´ÔºàÂÜçÁîü‚áîÂÅúÊ≠¢Ôºâ
        if (_isComparisonPlaying)
        {
            ComparisonMode.Pause();
            _isComparisonPlaying = false;
        }
        else
        {
            ComparisonMode.Play();
            _isComparisonPlaying = true;
        }
        StateHasChanged();
    }

    private void OnSeek(int index)
    {
        // „Éâ„É©„ÉÉ„Ç∞‰∏≠„ÅÆ„Ç∑„Éº„ÇØ„ÅØ„Çπ„É≠„ÉÉ„Éà„É™„É≥„Ç∞„ÇíÊúâÂäπÂåñ
        Playback.SeekTo(index, throttle: true);
    }

    private void OnVisualizationModeChanged()
    {
        Playback.State.Mode = SelectedVisualizationMode;
        StateHasChanged();
    }

    private void OnStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void ToggleComparisonPlayPause()
    {
        if (_isComparisonPlaying)
        {
            ComparisonMode.Pause();
            _isComparisonPlaying = false;
        }
        else
        {
            ComparisonMode.Play();
            _isComparisonPlaying = true;
        }
        StateHasChanged();
    }

    private void OnSpeedSettingsChanged()
    {
        DebugSettings.Log($"[Index] OnSpeedSettingsChanged called. _isComparisonMode: {_isComparisonMode}");
        DebugSettings.Log($"[Index] Current settings: OperationsPerFrame={Playback.OperationsPerFrame}, SpeedMultiplier={Playback.SpeedMultiplier}");
        
        // ÊØîËºÉ„É¢„Éº„Éâ„ÅåÊúâÂäπ„Å™Â†¥Âêà„ÄÅ„Åô„Åπ„Å¶„ÅÆ„Ç¢„É´„Ç¥„É™„Ç∫„É†„Å´ÈÄüÂ∫¶Ë®≠ÂÆö„ÇíÈÅ©Áî®
        if (_isComparisonMode)
        {
            ComparisonMode.SetSpeedForAll(Playback.OperationsPerFrame, Playback.SpeedMultiplier);
            DebugSettings.Log($"[Index] SetSpeedForAll called with ops={Playback.OperationsPerFrame}, speed={Playback.SpeedMultiplier}");
            
            // ÈÅ©Áî®Âæå„ÅÆÁ¢∫Ë™ç
            foreach (var instance in ComparisonMode.State.Instances)
            {
                DebugSettings.Log($"[Index]   {instance.AlgorithmName}: ops={instance.Playback.OperationsPerFrame}, speed={instance.Playback.SpeedMultiplier}");
            }
        }
        StateHasChanged();
    }

    public void Dispose()
    {
        Playback.StateChanged -= OnStateChanged;
        ComparisonMode.OnStateChanged -= OnStateChanged; // ÊØîËºÉ„É¢„Éº„Éâ„ÅÆ„Ç§„Éô„É≥„ÉàË≥ºË™≠Ëß£Èô§
    }
}

