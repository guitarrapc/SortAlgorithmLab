@using SortAlgorithm.VisualizationWeb.Models
@using SortAlgorithm.VisualizationWeb.Services

<div class="bar-chart-container @(State?.PlaybackState == PlaybackState.Playing ? "playing" : "")" 
     @onclick="OnCanvasClick" 
     style="position: relative; width: 100%; height: 100%;">
    
    @if (State != null && State.MainArray.Length > 0)
    {
        var arrayLength = State.MainArray.Length;
        
        // é…åˆ—ã‚µã‚¤ã‚ºã«å¿œã˜ã¦éš™é–“ã‚’èª¿æ•´
        double gapRatio;
        if (arrayLength <= 256)
        {
            gapRatio = 0.15; // 15%ã®éš™é–“ï¼ˆå°ã•ã„é…åˆ—ã¯è¦‹ã‚„ã™ãï¼‰
        }
        else if (arrayLength <= 1024)
        {
            gapRatio = 0.10; // 10%ã®éš™é–“
        }
        else
        {
            gapRatio = 0.05; // 5%ã®éš™é–“ï¼ˆå¤§ãã„é…åˆ—ã¯å¯†é›†ã•ã›ã‚‹ï¼‰
        }
        
        var minBarWidth = 1.0; // æœ€å°ãƒãƒ¼å¹…ï¼ˆpxï¼‰
        var baseWidth = 1200; // ãƒ™ãƒ¼ã‚¹å¹…
        var baseHeight = 600; // ãƒ™ãƒ¼ã‚¹é«˜ã•ï¼ˆã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”ã®åŸºæº–ï¼‰
        var requiredWidth = Math.Max(baseWidth, (int)(arrayLength * minBarWidth / (1.0 - gapRatio)));
        var totalBarWidth = (double)requiredWidth / arrayLength;
        var barWidth = totalBarWidth * (1.0 - gapRatio); // å®Ÿéš›ã®ãƒãƒ¼å¹…ï¼ˆéš™é–“ã‚’é™¤ãï¼‰
        var gap = totalBarWidth * gapRatio; // éš™é–“ã®å¹…
        var maxValue = State.MainArray.Max();
        
        <svg width="100%" height="100%" viewBox="0 0 @requiredWidth @baseHeight" preserveAspectRatio="xMidYMax meet" style="display: block;">
            <g shape-rendering="crispEdges">
                @for (int i = 0; i < arrayLength; i++)
                {
                    var value = State.MainArray[i];
                    var barHeight = (value / (double)maxValue) * (baseHeight - 20);
                    var x = i * totalBarWidth + (gap / 2); // éš™é–“ã®åŠåˆ†ã‚’å·¦å´ã«é…ç½®
                    var y = baseHeight - barHeight;
                    var color = GetBarColor(i);
                    
                    <rect @key="i"
                          x="@x" 
                          y="@y" 
                          width="@barWidth" 
                          height="@barHeight"
                          fill="@color"
                          stroke="none" />
                }
            </g>
        </svg>
    }
    else
    {
        <div style="text-align: center; color: #999;">
            <p style="font-size: 2rem;">ğŸ“Š</p>
            <p>Click "Generate & Sort" to start visualization</p>
        </div>
    }
</div>

@code {
    [Parameter]
    public VisualizationState? State { get; set; }
    
    [Parameter]
    public EventCallback OnClick { get; set; }
    
    private string GetBarColor(int index)
    {
        if (State == null) return "#3B82F6";
        
        if (State.SwapIndices.Contains(index)) return "#EF4444"; // Red - Swap
        if (State.CompareIndices.Contains(index)) return "#A855F7"; // Purple - Compare
        if (State.WriteIndices.Contains(index)) return "#F97316"; // Orange - Write
        if (State.ReadIndices.Contains(index)) return "#FBBF24"; // Yellow - Read
        
        return "#3B82F6"; // Blue - Normal
    }
    
    private async Task OnCanvasClick()
    {
        await OnClick.InvokeAsync();
    }
}

